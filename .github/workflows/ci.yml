name: XDB-Project CI Configuration

# Run CI for all branches and enforce strict checks on pull requests to main
on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main

# Apply principle of least privilege for security
permissions:
  contents: read

# Global environment variables for build paths
env:
  BUILD_DIR: build
  BIN_DIR: bin

jobs:
  # Stage 1: Code Style Verification
  # Ensures consistent formatting across the codebase using clang-format.
  style-check:
    name: Style Check (clang-format)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install necessary formatting tools
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      # Execute dry-run to catch style violations
      - name: Verify C source formatting
        run: |
          FILES=$(find src include tests -name "*.c" -o -name "*.h")
          if [ -n "$FILES" ]; then
            clang-format --dry-run --Werror $FILES
          else
            echo "No C source files found. Skipping format check."
          fi

  # Stage 2: Static Code Analysis
  # Detects potential bugs, logic errors, and bad practices early.
  static-analysis:
    name: Static Analysis (cppcheck)
    runs-on: ubuntu-latest
    needs: style-check
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install analysis tools
      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      # Run comprehensive static analysis checks
      - name: Run cppcheck analysis
        run: |
          cppcheck \
            --enable=warning,style,performance,portability \
            --inline-suppr \
            --suppressions-list=.cppcheck_suppress \
            --std=c11 \
            --error-exitcode=1 \
            src/ include/

  # Stage 3: Build and Unit Testing
  # Compiles the project and executes the test suite on GCC and Clang.
  build-and-test:
    name: Build and Test (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    needs: style-check
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Prepare compilation environment
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            clang \
            make

      # Set compiler based on matrix
      - name: Select compiler
        run: echo "CC=${{ matrix.compiler }}" >> $GITHUB_ENV

      # Clean and compile
      - name: Build project
        run: |
          make clean
          make

      # Execute binary unit tests
      - name: Run unit tests
        run: make test

  # Stage 4: Memory Leak Detection
  # Verifies memory safety using Valgrind (PRs to main only).
  memory-check:
    name: Memory Check (valgrind)
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 20
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install memory debugging tools
      - name: Install valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      # Build with debug symbols
      - name: Build project for valgrind
        run: |
          make clean
          make

      # Run memory analysis on test_runner
      - name: Run valgrind memory analysis
        run: |
          valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --error-exitcode=1 \
            ./bin/test_runner

  # Stage 5: CI Summary
  # Aggregates results to provide a high-level status of the pipeline.
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - style-check
      - static-analysis
      - build-and-test
      - memory-check
    if: always()
    steps:
      # Final output for GitHub Actions console
      - name: Print CI results summary
        run: |
          echo "XDB-Project CI Pipeline Finished"
          echo "Style Check result      : ${{ needs.style-check.result }}"
          echo "Static Analysis result  : ${{ needs.static-analysis.result }}"
          echo "Build and Test result   : ${{ needs.build-and-test.result }}"
          echo "Memory Check result     : ${{ needs.memory-check.result }}"
          